language: android
env:
  global:
  - MALLOC_ARENA_MAX=2
  - secure: gKWVu6Ub6LKVtt+d+qKWg5TMqmRL5OmyPdEXZBWkc9yEzcb3QGTPAUoZU7Q0/5g94mbqroWyEMnCo/cta1ZSL1laGVNN4RX6FVlk7RyDWpL1KB+jTjaskti0hUvXMWOSEs9/3Q2NFmGcHreNMadAFa+mIH90njWipWCyERx7XUttpYQxKgS3SV62Bci0impfq9E2d6Loj0O4Mo0MujcYo3A6nZ36Xtjwmbqo+/GyQrFo46CxdgOQxmN0aesSF/HY5us3AO2SOM4+6KjdPzROesID++SYTpBcmqf4f3Xt7upz5ljmBdn9D1mKkClAqlQWLZixP9Ctjlh5X0SGGRx5h4xFBg2L297m0aeCX+NrQHLqagugU3OP33uLFh3VejPumLJ7b/rJbxKp/ZrN+GjEhaSEkUgND32LwLa02Fpq/6HxNS+tuKSwtvcjqGJ6BoRE6R6XThyzoGVXhfLtoHqdo6Na0n/TfdC9nczOthFPHnXT7conQWgly3+SuUBsW51WMGZgp12Yn/nT3ke6mlUlPdI56HRy25JDpM6ii9o6cxAt7z4lxuctLfLqId7O/9L78IXPYJPqwxWLbHtxPTb/AaOTiK3qozhHRF7Oqcq8aYcEjoARGylqA+grMXihhCEne9ETUtKSt5yxiWW2gHkanUK5ZfUehk5v68tWD6i7OHA=
  - secure: lrnzhMmgnUzBW9jmcKdSBtdKc1llI1LcUXLeOeAfimzNMJUCQzGtY7unSbxZ28bc9l/qAjYkoDcHqjhhLk55jg4gcxHfkGj6WhxIg0xpTixh/iSjNvg8X59yntUsQt1f4/Xh/f3K9YSnmVbLN+DaBlAuilMr0CQZDfne90HVqK1Vu1RuojGKYMHGCH80Ic1FCvYRb7JMq6vB8l0OI0o9UldQajWJN0icM1826G1V/gFVW4MUhcOEGqpxVchCF9n8ucR5vxgtvv+bRpPxrfVINPQEMTiu7OpadoSCEWuBTg1ZJYF2Et/CRdq2vhp+GtDk3/RdFrKuqv7SqxwCsq258kE7lbAOPi5w81b0LiXq4XknCy2G2qyoU2KMI5tGmtPB4aIyH1mXAu1uykzqJc511ZlLfB2OK2DpJEoxlNJ1VnBFlJLmCSVQjVV9xgaZ35V/0KWo0QCOzTTmg38u5y/jC+2q4PL/qFz+1N8nXMXYxXKgZRWT2lY1rJXBvLo5//nzw06vnqGA1DRMQ+Y1ymHXY5beqj450/R2bKOVtb8312uJ3katdLbp8g9lkuMPCfMR+y8MLjLa2wXx5gp2yebqAzf81fVAhYiIlOpSRpz+uQGEz1y1Pd6okLiEIE7uqO8UuBeIwQlD+ThuylIlTV2G8tBnuq5CDu7Ejhy/hUiWbVU=
  - secure: hg2NDYO4cxGyL7Wsvzh103OAWAVhVcWGtySWAY3ETGvwfCf6u6MBsB2OCkTLiCNJ7TE6KnmxsAE5dgZwk5ls2/t8gYfP8SLkJGTXRiYoVSYb+COQRkMK2BDFutRO7jz1QkybwqkEnONaclAj2/sDxb2n8uf2U6upJzHVJ5IPT6Lzt97F5xT2XZ6Junflkx2mVU5On84mmEYPMp52DS5/P2MsfbIn+GkBl/6nhFCs5sKUxuTRZG6UKrN3wXxDmH84SOdWOwXMF+xA4Gw8PQ7Rx39Th31ikEZ/315Rfu/spcPRnks/Ne/K2i39U/Ip0x6mRNRAv9QcQjWn972QZ8HG+026aOM517phC2MjHabMCO6JXsjyQzMvkqSnqYF3Op3dvS1I2ax1o/clrwCYtj4nIOYNhMB8D+lSQgLsycGLVPYeRqinPyGPbSjClw8kqnYa1EpjeRGrP7qj5jSSqAsmYMFmG3CmRLJ7Dw71gV5Y+2DCVWWuzar6DO1BDB1UeuflT7zsDoy6jAs4RNueSzWPlgTXNHooZgQD2cq4kzE9mryX8QovxtgtAjua3RZw/fW47wOxXW2x12jIBtJdES6Dg+e/XfYKLV5EfcZirGN85VJlkrNjoxueaZWYA6r4M7xKGo7SmUPp3EYYoPdEDlsM1/SCebiEUss86TEUois7odc=
  matrix:
  - ANDROID_SDKS=android-19,sysimg-19 ANDROID_TARGET=android-19 ANDROID_ABI=armeabi-v7a
    ENABLE_GPL_THIRD_PARTIES=0 BUILD_VIDEO=1 BUILD_OPENH264=1 ENABLE_OPENH264_DECODER=1
    BUILD_X264=0 BUILD_AMRNB=full BUILD_AMRWB=1 BUILD_ZRTP=1 BUILD_SILK=1 BUILD_G729=1
    BUILD_TUNNEL=0 BUILD_WEBRTC_AECM=1 USE_JAVAH=1 BUILD_FOR_X86=1 BUILD_SQLITE=1
    BUILD_TLS=1 BUILD_WEBRTC_ISAC=1 BUILD_OPUS=1 BUILD_UPNP=1 BUILD_MATROSKA=0 BUILD_ILBC=1
sudo: false
addons:
  apt:
    packages:
    - yasm
    - nasm
    - curl
    - ant
    - rsync
    - autoconf
    - automake
    - libtool
    - pkg-config
    - bc
    - libwww-perl
    - ruby
cache:
  apt: true
  bundler: true
  ccache: true
  directories:
  - "$HOME/.ccache"
before_install:
- if [ `uname -m` = x86_64 ]; then wget --timeout=120 http://dl.google.com/android/ndk/android-ndk-r10e-linux-x86_64.bin
  -O ndk.bin ; else wget --timeout=120 http://dl.google.com/android/ndk/android-ndk-r10e-linux-x86.bin
  -O ndk.bin ; fi
- chmod 755 ndk.bin ; ./ndk.bin 2>&1 | grep -v Extracting
- export ANDROID_NDK=$PWD/android-ndk-r10e
- export PATH=${ANDROID_NDK}:${ANDROID_NDK}/ndk-build:${ANDROID_HOME}/tools:${ANDROID_HOME}/platform-tools:$PATH
- export NDK_CACHE=ccache
- export ANDROID_MOST_RECENT_TARGET=android-19
- which bundler || gem install bundler
- bundle install
android:
  components:
  - build-tools-19.1.0
  - build-tools-20.0.0
  - build-tools-22.0.1
  - android-19
  - android-20
  - android-22
  - extra-google-google_play_services
  - extra-google-m2repository
  - extra-android-m2repository
  - addon-google_apis-google-19
  - addon-google_apis-google-20
  - addon-google_apis-google-22
before_script:
- echo "Starting to update submodules"
- if [ ! -d submodules/linphone/oRTP/.git ]; then rm -fr submodules/linphone/oRTP/
  ; git clone git://git.linphone.org/ortp.git submodules/linphone/oRTP ; fi
- if [ ! -d submodules/linphone/mediastreamer2/.git ]; then rm -fr submodules/linphone/mediastreamer2/
  ; git clone git://git.linphone.org/mediastreamer2.git submodules/linphone/mediastreamer2
  ; fi
- if [ ! -d submodules/mswebrtc/webrtc/.git ]; then rm -fr submodules/mswebrtc/webrtc/
  ; git clone git://git.linphone.org/webrtc.git submodules/mswebrtc/webrtc ; fi
- git submodule update --init --recursive
- echo "Finished updating submodules"
- android list target -c
script:
- "./Tools/prepare_crashlytics.sh"
- "./Tools/travis_script.sh"
- find . -name '*.apk' -exec ls -la {} \;
before_cache:
- echo "before_cache"
after_success:
- echo "after_success"
- if [ "$TRAVIS_BRANCH" = "master" ]; then "./Tools/github_release.sh"; fi
after_failure:
- echo "after_failure"
after_script:
- echo "after_script"
notifications:
  slack:
    secure: PbV38W/sM4KC9zan3fNkMhqOl9uISNkqtmqrKruuNXMM0uOXEmAP57cyHP3k8B2UEAECXVRRmD3VtVJmQt+y9abaR1YUIRdMlRgkSoXmy4vAVh9tveZvNkohFzlfNCLS4oGiT/bodCuLpVP7AwT97l0eRZXABCx1+x0Ju7sHyXA=
  flowdock:
    secure: MBa7gMw7ZTltp3rU3f74ICF75a587CSRwkZqY6RFnwVv3U3Jy0yIt7GdYp45Zwb5hyUK2iLNAPwAtwPoClRwZskZdKx8QEat8c2UP3MNJRU7vrAX9AnIiEwQfCEcTVzZA7p+cfuQyQqJafuCbE+e0GZ60GgAU95JWklJ3OCaWDjWVZolR0T6aBGT/QGEn85UASpJOR+II6HRhpqcv937pjpnT6g8//g5fY5o9rVS22Lwcx4s0zBiuiang5vEFbjN+iX0Glo4Ky+thduxKg51+6Qo1up3xHesMggRpgNX0a0bRD7qLGLeTumdP6zkrUCDxXGKm2WekAwrCvyzpC8DGLB96hpdZ3VnPltYv1cifRE66tjv+PU3waUBGn69FsejZiuopA+I+nwOeNhVphkeQ4pG5kjrZgRF8/fF1CBVjK/U3pV8XmLsruzi7lMvKW5VwcRXg7nGnArSKSFl2sufz96TLvHjJnk6KkSv/qyCZ75AXLWTpynrI3jB6c8s3BvvRWZW9+bp1yenr7jTvgnrQP01C2ukWYxetoumdYoK6KKj+qCZ1wdQBiIMrNLRBxmUjIvaSXYM/dGQKTAjn/rKMzpaHuwqrPvWvQTfEbpkhA7/u1w+CP2T2YSrStn/PEYGsZJNYmluKjT6XgYrHCQBHGmHrmk2WU4Ojl2xxFjBZMI=
